"use client";

import * as React from "react";
import { useRouter } from "next/navigation";
import { useForm } from "react-hook-form";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { LogOut, Save, User, Mail } from "lucide-react";

import { useAuthStore } from "@/stores/useAuthStore";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  ALL_ALLOWED_KEYWORDS,
  createEmptyLanguageScores,
  TESTS,
} from "@/lib/profileConfig";
import type { LanguageScores, TestKey } from "@/lib/profileConfig";
import { useMajors } from "@/hooks/useMajors";
import type { ProfileFormValues } from "@/types/profile";
import { ProfileKeywordSelector } from "@/components/profile/ProfileKeywordSelector";
import { ProfileBasicFields } from "@/components/profile/ProfileBasicFields";
import { ProfileAdditionalFields } from "@/components/profile/ProfileAdditionalFields";
import { ProfileLanguageFields } from "@/components/profile/ProfileLanguageFields";
import { FieldError } from "@/components/profile/FieldError";

const API_BASE = process.env.NEXT_PUBLIC_API_BASE ?? "http://localhost:8000";
const ALLOWED_KEYWORD_SET = new Set(ALL_ALLOWED_KEYWORDS);

interface UserMe {
  id: string;
  email: string;
  created_at: string;
}

interface UserProfile {
  user_id: string;
  gender?: (typeof GENDER_OPTIONS)[number]["value"] | null;
  age: number | null;
  major: string | null;
  grade: number | null;
  keywords: string[] | null;
  military_service: (typeof MILITARY_OPTIONS)[number]["value"] | null;
  income_bracket: number | null;
  gpa: number | null;
  language_scores: Record<string, number> | null;
  created_at: string;
  updated_at: string;
}

function sanitizeKeywords(keywords: string[]): string[] {
  if (!keywords) return [];
  const unique = new Set<string>();
  keywords.forEach((kw) => {
    const trimmed = kw.trim();
    if (ALLOWED_KEYWORD_SET.has(trimmed)) {
      unique.add(trimmed);
    }
  });
  return Array.from(unique);
}

function buildLanguageScoresFromProfile(
  input: Record<string, number> | null | undefined
): LanguageScores {
  const base = createEmptyLanguageScores();
  if (!input) return base;
  (Object.keys(base) as TestKey[]).forEach((key) => {
    const score = input[key];
    if (score != null && !Number.isNaN(Number(score))) {
      base[key] = { enabled: true, score: String(score) };
    }
  });
  return base;
}

function extractLanguageScores(data: LanguageScores): Record<string, number> {
  const result: Record<string, number> = {};
  (Object.keys(data) as TestKey[]).forEach((key) => {
    const { enabled, score } = data[key];
    if (!enabled) return;
    const numeric = Number(String(score).replace(/[^0-9.]/g, ""));
    if (!Number.isNaN(numeric) && String(score).trim() !== "") {
      result[key] = numeric;
    }
  });
  return result;
}

export default function ProfilePage() {
  const router = useRouter();
  const queryClient = useQueryClient();
  const { token, logout, user } = useAuthStore();

  const {
    data: userMe,
  } = useQuery<UserMe>({
    // Include token so switching accounts refetches instead of reusing cache
    queryKey: ["user", "me", token],
    queryFn: async () => {
      const res = await fetch("/api/auth/me", {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (!res.ok) throw new Error("Failed to fetch user info");
      return res.json();
    },
    enabled: !!token,
  });

  const {
    data: profile,
    isLoading: isProfileLoading,
  } = useQuery<UserProfile | null>({
    // Include token to avoid showing another account's cached profile
    queryKey: ["user", "profile", token],
    queryFn: async () => {
      const res = await fetch("/api/auth/me/profile", {
        headers: { Authorization: `Bearer ${token}` },
      });
      if (res.status === 404) {
        return null;
      }
      if (!res.ok) {
        throw new Error("Failed to fetch profile");
      }
      return res.json();
    },
    enabled: !!token,
  });

  const {
    data: majorsData = [],
    isLoading: majorsLoading,
  } = useMajors();

  const form = useForm<ProfileFormValues>({
    mode: "onTouched",
    defaultValues: {
      gender: "prefer_not_to_say",
      age: "",
      grade: "1",
      college: "",
      major: "",
      military_service: "",
      income_bracket: "",
      gpa: "",
      keywords: [],
      languageScores: createEmptyLanguageScores(),
    },
  });

  React.useEffect(() => {
    if (profile === undefined) return;

    if (profile === null) {
      form.reset({
        gender: "prefer_not_to_say",
        age: "",
        grade: "1",
        college: "",
        major: "",
        military_service: "",
        income_bracket: "",
        gpa: "",
        keywords: [],
        languageScores: createEmptyLanguageScores(),
      });
      return;
    }

    const sanitizedKeywords = sanitizeKeywords(profile.keywords || []);
    const languageScoresFromProfile = buildLanguageScoresFromProfile(
      profile.language_scores
    );
    const gradeString = ALLOWED_GRADES.includes(
      String(profile.grade ?? "1") as (typeof ALLOWED_GRADES)[number]
    )
      ? (String(profile.grade) as (typeof ALLOWED_GRADES)[number])
      : "1";
    const ageString = profile.age != null ? String(profile.age) : "";

    form.reset({
      gender: profile.gender ?? "prefer_not_to_say",
      age: ageString,
      grade: gradeString,
      college: form.getValues("college"),
      major: profile.major ?? "",
      military_service: profile.military_service ?? "",
      income_bracket:
        profile.income_bracket != null ? String(profile.income_bracket) : "",
      gpa: profile.gpa != null ? String(profile.gpa) : "",
      keywords: sanitizedKeywords,
      languageScores: languageScoresFromProfile,
    });
  }, [profile, form]);

  React.useEffect(() => {
    if (!profile || !profile.major || majorsData.length === 0) return;
    const currentCollege = form.getValues("college");
    if (currentCollege) return;
    const matched = majorsData.find((item) =>
      item.majors.includes(profile.major ?? "")
    );
    if (matched) {
      form.setValue("college", matched.college);
    }
  }, [profile, majorsData, form]);

  React.useEffect(() => {
    if (!token) {
      router.push("/login");
    }
  }, [token, router]);

  const updateProfile = useMutation({
    mutationFn: async (payload: Record<string, unknown>) => {
      const res = await fetch("/api/auth/me/profile", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const error = await res.json().catch(() => null);
        throw new Error(error?.error || "Failed to update profile");
      }

      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["user", "profile"] });
      // Refresh personalized and related caches after profile change
      queryClient.invalidateQueries({ queryKey: ["recommended"] });
      queryClient.invalidateQueries({ queryKey: ["notice", "eligibility"] });
      queryClient.invalidateQueries({ queryKey: ["notices"] });
      alert("?ÑÎ°ú?ÑÏù¥ ?ÖÎç∞?¥Ìä∏?òÏóà?µÎãà??");
    },
    onError: (error: Error) => {
      alert(`?ÑÎ°ú???ÖÎç∞?¥Ìä∏ ?§Ìå®: ${error.message}`);
    },
  });

  const handleLogout = () => {
    if (confirm("Î°úÍ∑∏?ÑÏõÉ?òÏãúÍ≤†Ïäµ?àÍπå?")) {
      logout();
      router.push("/login");
    }
  };

  const onSubmit = (data: ProfileFormValues) => {
    const sanitizedKeywords = sanitizeKeywords(data.keywords);
    if (sanitizedKeywords.length === 0) {
      form.setError("keywords", {
        type: "validate",
        message: "?§Ïõå?úÎ? ÏµúÏÜå 1Í∞??¥ÏÉÅ ?†ÌÉù?¥Ï£º?∏Ïöî",
      });
      return;
    }

    if (!data.major) {
      form.setError("major", {
        type: "validate",
        message: "?ÑÍ≥µ???†ÌÉù?¥Ï£º?∏Ïöî",
      });
      return;
    }

    if (!data.college) {
      form.setError("college", {
        type: "validate",
        message: "?®Í≥º?ÄÎ•??†ÌÉù?¥Ï£º?∏Ïöî",
      });
      return;
    }

    const ageNum = Number.parseInt(data.age, 10);
    if (Number.isNaN(ageNum) || ageNum < 15 || ageNum > 100) {
      form.setError("age", {
        type: "validate",
        message: "?òÏù¥??15~100 ?¨Ïù¥???´ÏûêÎ°??ÖÎ†•?¥Ï£º?∏Ïöî",
      });
      return;
    }

    const gradeNum = Number.parseInt(data.grade, 10);
    if (Number.isNaN(gradeNum)) {
      form.setError("grade", {
        type: "validate",
        message: "?ôÎÖÑ???†ÌÉù?¥Ï£º?∏Ïöî",
      });
      return;
    }

    const language_scores = extractLanguageScores(data.languageScores);

    const payload: Record<string, unknown> = {
      age: ageNum,
      major: data.major,
      grade: gradeNum,
      keywords: sanitizedKeywords,
    };

    if (data.gender && data.gender !== "prefer_not_to_say") {
      payload.gender = data.gender;
    }

    if (data.military_service) {
      payload.military_service = data.military_service;
    }

    if (data.income_bracket !== "") {
      const incomeNum = Number(data.income_bracket);
      if (!Number.isNaN(incomeNum)) {
        payload.income_bracket = incomeNum;
      }
    }

    if (data.gpa.trim() !== "") {
      const gpaNum = Number(data.gpa);
      if (!Number.isNaN(gpaNum)) {
        payload.gpa = Number(gpaNum.toFixed(2));
      }
    }

    if (Object.keys(language_scores).length > 0) {
      payload.language_scores = language_scores;
    }

    updateProfile.mutate(payload);
  };

  if (!token) {
    return null;
  }

  return (
    <main className="mx-auto max-w-2xl px-4 py-6 pb-32 animate-in fade-in duration-300">
      <h1 className="mb-6 text-2xl font-semibold text-gray-900">?§Ï†ï</h1>

      <section className="mb-8 rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="mb-4 flex items-center gap-2 text-lg font-semibold">
          <User className="h-5 w-5" />
          ?¨Ïö©???ïÎ≥¥
        </h2>
        <div className="space-y-2 text-sm text-gray-600">
          <div className="flex items-center gap-2">
            <Mail className="h-4 w-4" />
            <span>{userMe?.email || user?.email || "?¥Î©î???ïÎ≥¥ ?ÜÏùå"}</span>
          </div>
        </div>
      </section>

      <section className="mb-8 rounded-lg border border-gray-200 bg-white p-6">
        <h2 className="mb-4 text-lg font-semibold">?ÑÎ°ú???òÏ†ï</h2>

        {isProfileLoading ? (
          <div className="text-sm text-gray-500">?ÑÎ°ú?ÑÏùÑ Î∂àÎü¨?§Îäî Ï§?..</div>
        ) : (
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <ProfileBasicFields form={form} majors={majorsData} majorsLoading={majorsLoading} />
            <ProfileAdditionalFields form={form} />
            <ProfileKeywordSelector form={form} />
            <ProfileLanguageFields form={form} />

            <Button
              type="submit"
              className="w-full"
              disabled={updateProfile.isPending}
            >
              <Save className="mr-2 h-4 w-4" />
              {updateProfile.isPending ? "?Ä??Ï§?.." : "?ÑÎ°ú???Ä??}
            </Button>
          </form>
        )}
      </section>

      <section className="rounded-lg border border-red-200 bg-red-50 p-6">
        <h2 className="mb-4 text-lg font-semibold text-red-900">Í≥ÑÏ†ï Í¥ÄÎ¶?/h2>
        <Button
          variant="destructive"
          onClick={handleLogout}
          className="w-full"
        >
          <LogOut className="mr-2 h-4 w-4" />
          Î°úÍ∑∏?ÑÏõÉ
        </Button>
      </section>

      <Modal
        open={false} // keywordModalParent is removed, so this will always be false
        title={""} // keywordModalParent is removed, so this will always be ""
        onClose={() => {}} // keywordModalParent is removed, so this will always be a no-op
      >
        {/* This modal content is no longer used as keywordModalParent is removed */}
      </Modal>
    </main>
  );
}

function FieldError({ message }: { message?: string }) {
  if (!message) return null;
  return <p className="text-xs text-red-600">{message}</p>;
}

function SelectedKeywordsPreview({
  keywords,
  onRemove,
}: {
  keywords: string[];
  onRemove: (keyword: string) => void;
}) {
  if (!keywords || keywords.length === 0) {
    return <p className="text-xs text-gray-500">?†ÌÉù???§Ïõå?úÍ? ?ÜÏäµ?àÎã§.</p>;
  }
  return (
    <div className="flex flex-wrap gap-2">
      {keywords.map((keyword) => (
        <span
          key={keyword}
          className="inline-flex items-center gap-2 rounded-full border border-blue-200 bg-blue-50 px-3 py-1.5 text-sm text-blue-700"
        >
          {keyword}
          <button
            type="button"
            onClick={() => onRemove(keyword)}
            className="text-xs text-blue-600 hover:text-blue-800"
            aria-label={`${keyword} ?úÍ±∞`}
          >
            ??
          </button>
        </span>
      ))}
    </div>
  );
}

function KeywordModalContent({
  parent,
  keywords,
  onToggleAll,
  onToggleOne,
}: {
  parent: string;
  keywords: string[];
  onToggleAll: () => void;
  onToggleOne: (child: string) => void;
}) {
  const children = KEYWORDS_TREE[parent] ?? [];
  const allSelected =
    children.length > 0 && children.every((child) => keywords.includes(child));

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="text-sm font-semibold text-gray-800">{parent} ?∏Î? ?§Ïõå??/h3>
        {children.length > 0 && (
          <button
            type="button"
            onClick={onToggleAll}
            className="rounded border border-gray-300 px-2 py-1 text-xs hover:bg-gray-100"
          >
            {allSelected ? "?ÑÏ≤¥ ?¥Ï†ú" : "?ÑÏ≤¥ ?†ÌÉù"}
          </button>
        )}
      </div>

      {children.length === 0 ? (
        <p className="text-xs text-gray-500">?∏Î? ?§Ïõå?úÍ? ?ÜÏäµ?àÎã§.</p>
      ) : (
        <div className="flex flex-wrap gap-2">
          {children.map((child) => {
            const selected = keywords.includes(child);
            return (
              <button
                key={child}
                type="button"
                onClick={() => onToggleOne(child)}
                className={`rounded-full px-3 py-1.5 text-sm font-medium transition-colors ${
                  selected
                    ? "bg-blue-600 text-white"
                    : "bg-white text-gray-700 border border-gray-300 hover:bg-gray-100"
                }`}
              >
                {child}
              </button>
            );
          })}
        </div>
      )}
    </div>
  );
}

function Modal({
  open,
  title,
  onClose,
  children,
}: {
  open: boolean;
  title: string;
  onClose: () => void;
  children: React.ReactNode;
}) {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4" role="dialog" aria-modal="true">
      <div className="w-full max-w-lg rounded-xl border border-gray-200 bg-white shadow-xl">
        <div className="flex items-center justify-between border-b px-5 py-3">
          <h3 className="text-base font-semibold">{title}</h3>
          <button
            type="button"
            onClick={onClose}
            className="text-sm text-gray-500 hover:text-gray-700"
          >
            ?´Í∏∞
          </button>
        </div>
        <div className="p-5">{children}</div>
      </div>
    </div>
  );
}


